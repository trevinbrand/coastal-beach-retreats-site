---
import "../styles/global.css";
import SiteHeader from "../components/SiteHeader.astro";
import HeroCarousel from "../components/HeroCarousel.astro";
import PropertyBlock from "../components/PropertyBlock.astro";
import SiteFooter from "../components/SiteFooter.astro";
import { properties } from "../data/properties.js";

// Group properties by city
const groups = properties.reduce((acc, p) => {
  const key = p.city || "Other";
  (acc[key] ||= []).push(p);
  return acc;
}, {});

// Order cities
const cityOrder = ["Panama City Beach, FL", "Destin, FL"];
const orderedCities = [
  ...cityOrder.filter((c) => groups[c]),
  ...Object.keys(groups).filter((c) => !cityOrder.includes(c)),
];

// Helper: pull slug from p.href (stable)
const slugFromHref = (href = "") =>
  href.replace(/^\/+|\/+$/g, "").split("/").pop() || "";
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Coastal Beach Retreats</title>
    <meta
      name="description"
      content="Discover Coastal Beach Retreats – luxury beachfront vacation rentals in Panama City Beach and Destin."
    />
  </head>

  <body>
    <SiteHeader phone="(918) 734-3331" />

    <HeroCarousel />

    <main class="wrap">
      <section class="brand-divider">
        <img
          src="/images/coastal-beach-retreats-welcome.png"
          alt="Welcome to Coastal Beach Retreats"
          loading="eager"
        />
      </section>

      <!-- LOCATION SELECT (arrow scroll target) -->
      <nav
        class="location-switcher"
        id="location-select"
        aria-label="Browse by location"
      >
        <p class="location-label">Browse by location</p>
        <div class="location-buttons">
          <a class="loc-btn pcb-btn" href="#heavenly-hideaway">Panama City Beach</a>
          <a class="loc-btn destin-btn" href="#destin-dreams">Destin</a>
        </div>
      </nav>

      <!-- PROPERTIES -->
      {orderedCities.map((city) => (
        <section class="section">
          {/* Keep Destin heading only */}
          {city === "Destin, FL" && <h2 class="city-heading">{city}</h2>}

          {groups[city].map((p) => {
            const slug = slugFromHref(p.href);

            // Only create anchors for the two featured buttons
            const anchorId =
              slug === "heavenly-hideaway"
                ? "heavenly-hideaway"
                : slug === "destin-dreams"
                ? "destin-dreams"
                : null;

            return (
              <div class="prop">
                {anchorId && <span id={anchorId} class="jump-anchor" aria-hidden="true"></span>}
                <PropertyBlock p={p} />
              </div>
            );
          })}
        </section>
      ))}

      <!-- REVIEWS -->
      <section class="section" id="reviews">
        <h2 class="reviews-title">Guest Reviews</h2>
        <hr class="rule" />

        <div
          class="ownerrez-widget"
          data-widget-type="Reviews - Reviews"
          data-widgetId="4bf99f90fcf54552a13fd7315759dbca"
        ></div>

        <script is:inline src="https://app.ownerrez.com/widget.js"></script>
      </section>
    </main>

    <SiteFooter phone="(918) 734-3331" email="coastalbeachretreats@gmail.com" />

    <style>
      /* ✅ Match your property page spacing */
      .wrap {
        max-width: 1440px;
        margin: 0 auto;
        padding: 12px 10px;
      }

      .section {
        padding: 14px 0;
      }

      .prop {
        margin: 0 0 6px;
      }

      .city-heading {
        margin: 8px 0 12px;
      }

      .reviews-title {
        margin: 0 0 8px;
      }

      .rule {
        border: 0;
        border-top: 1px solid rgba(0,0,0,.10);
        margin: 12px 0 16px;
      }

      /* ✅ Reliable anchor offset for sticky header */
      .jump-anchor {
        display: block;
        height: 1px;
        margin-top: -96px; /* offset = sticky header height */
        padding-top: 96px;
      }

      /* Also keep the nav target from hiding under header */
      #location-select {
        scroll-margin-top: 96px;
      }

      @media (max-width: 980px) {
        .wrap {
          padding: 12px 12px;
        }
        .jump-anchor {
          margin-top: -88px;
          padding-top: 88px;
        }
      }
    </style>
  </body>
</html>
